/*
*********************************************************************************************************
*                                             
*	æ¨¡å—åç§° : ADS1256 é©±åŠ¨æ¨¡å—(8é€šé“å¸¦PGAçš„24ä½ADC)
*	æ–‡ä»¶åç§° : bsp_ads1256.c
*	ç‰ˆ    æœ¬ : V1.1
* ä½œ    è€… : å¼ è±ªæ´‹
*	è¯´    æ˜ : ADS1256æ¨¡å—å’ŒCPUä¹‹é—´é‡‡ç”¨SPIæ¥å£ã€‚
*********************************************************************************************************
*/
#include "ads1256.h"

extern TIM_HandleTypeDef htim3;

/*********************************************************
****æ™®é€šå®šæ—¶å™¨å®ç°uså»¶æ—¶
*********************************************************/
void delay_us(uint32_t nus)
{

 uint16_t  differ = 0xffff-nus-5;
 //è®¾ç½®å®šæ—¶å™¨2çš„è®¡æ•°åˆå§‹å€¼
  __HAL_TIM_SetCounter(&htim3,differ);
  //å¼€å¯å®šæ—¶å™¨
  HAL_TIM_Base_Start(&htim3);

  while( differ<0xffff-5)
 {
  differ = __HAL_TIM_GetCounter(&htim3);
 };
 //å…³é—­å®šæ—¶å™¨
  HAL_TIM_Base_Stop(&htim3);
}


/* å¯„å­˜å™¨å®šä¹‰ï¼š Table 23. Register Map --- ADS1256æ•°æ®æ‰‹å†Œç¬¬30é¡µ */
enum
{
	/* å¯„å­˜å™¨åœ°å€ï¼Œ åé¢æ˜¯å¤ä½åç¼ºçœå€¼ */
	REG_STATUS = 0,	// x1H
	REG_MUX    = 1, // 01H
	REG_ADCON  = 2, // 20H
	REG_DRATE  = 3, // F0H
	REG_IO     = 4, // E0H
	REG_OFC0   = 5, // xxH
	REG_OFC1   = 6, // xxH
	REG_OFC2   = 7, // xxH
	REG_FSC0   = 8, // xxH
	REG_FSC1   = 9, // xxH
	REG_FSC2   = 10, // xxH
};

/* å‘½ä»¤å®šä¹‰ï¼š TTable 24. Command Definitions --- ADS1256æ•°æ®æ‰‹å†Œç¬¬34é¡µ */
enum
{
	CMD_WAKEUP  = 0x00,	// Completes SYNC and Exits Standby Mode 0000  0000 (00h)
	CMD_RDATA   = 0x01, // Read Data 0000  0001 (01h)
	CMD_RDATAC  = 0x03, // Read Data Continuously 0000   0011 (03h)
	CMD_SDATAC  = 0x0F, // Stop Read Data Continuously 0000   1111 (0Fh)
	CMD_RREG    = 0x10, // Read from REG rrr 0001 rrrr (1xh)
	CMD_WREG    = 0x50, // Write to REG rrr 0101 rrrr (5xh)
	CMD_SELFCAL = 0xF0, // Offset and Gain Self-Calibration 1111    0000 (F0h)
	CMD_SELFOCAL= 0xF1, // Offset Self-Calibration 1111    0001 (F1h)
	CMD_SELFGCAL= 0xF2, // Gain Self-Calibration 1111    0010 (F2h)
	CMD_SYSOCAL = 0xF3, // System Offset Calibration 1111   0011 (F3h)
	CMD_SYSGCAL = 0xF4, // System Gain Calibration 1111    0100 (F4h)
	CMD_SYNC    = 0xFC, // Synchronize the A/D Conversion 1111   1100 (FCh)
	CMD_STANDBY = 0xFD, // Begin Standby Mode 1111   1101 (FDh)
	CMD_RESET   = 0xFE, // Reset to Power-Up Values 1111   1110 (FEh)
};

static void ADS1256_Send8Bit(uint8_t _data);
static uint8_t ADS1256_Recive8Bit(void);
static void ADS1256_WaitDRDY(void);
static void ADS1256_ResetHard(void);
//static void ADS1256_DelaySCLK(void);
 void ADS1256_DelayDATA(void);

void ADS1256_WriteCmd(uint8_t _cmd);
static void ADS1256_WriteReg(uint8_t _RegID, uint8_t _RegValue);
static uint8_t ADS1256_ReadReg(uint8_t _RegID);
static int32_t ADS1256_ReadData(void);
static void ADS1256_SetChannal(uint8_t _ch);
//static void ADS1256_SetDiffChannal(uint8_t _ch);

ADS1256_VAR_T g_tADS1256;
static const uint8_t s_tabDataRate[ADS1256_DRATE_MAX] =
{
	0xF0,		/* å¤ä½æ—¶ç¼ºçœå€¼ */
	0xE0,
	0xD0,
	0xC0,
	0xB0,
	0xA1,
	0x92,
	0x82,
	0x72,
	0x63,
	0x53,
	0x43,
	0x33,
	0x20,
	0x13,
	0x03
};

void bsp_DelayUS(u16 nus)
{
	delay_us(nus);
}
/*
*********************************************************************************************************
*	å‡½ æ•° å: bsp_InitADS1256
*	åŠŸèƒ½è¯´æ˜: é…ç½®STM32çš„GPIOå’ŒSPIæ¥å£ï¼Œç”¨äºè¿æ¥ ADS1256
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
void bsp_InitADS1256(void)
{
	ADS_RST_LOW();
	HAL_Delay(10);
	ADS_SYNC_HIGH();
	ADS_RST_HIGH();
////	HAL_Delay(100);
	//////é‡Šæ”¾SPIæ€»çº¿
	ADS_CS_HIGH();
	/* SPIæ€»çº¿ç©ºé—²æ—¶ï¼Œé’Ÿçº¿æ˜¯ä½ç”µå¹³ */
	ADS1256_CfgADC(ADS1256_GAIN_1, ADS1256_30000SPS);	/* é…ç½®ADCå‚æ•°ï¼š å¢ç›Š1:1, æ•°æ®è¾“å‡ºé€Ÿç‡ 1KHz */
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_CfgADC
*	åŠŸèƒ½è¯´æ˜: é…ç½®ADCå‚æ•°ï¼Œå¢ç›Šå’Œæ•°æ®è¾“å‡ºé€Ÿç‡
*	å½¢    å‚: _gain : å¢ç›Š
*			  _drate : æ•°æ®è¾“å‡ºé€Ÿç‡
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
void ADS1256_CfgADC(ADS1256_GAIN_E _gain, ADS1256_DRATE_E _drate)
{
	g_tADS1256.Gain = _gain;
	g_tADS1256.DataRate = _drate;

	ADS1256_StopScan();			/* æš‚åœCPUä¸­æ–­ */

	ADS1256_ResetHard();		/* ç¡¬ä»¶å¤ä½ */

	ADS1256_WaitDRDY();

	{
		uint8_t buf[4];		/* æš‚å­˜ADS1256 å¯„å­˜å™¨é…ç½®å‚æ•°ï¼Œä¹‹åè¿ç»­å†™4ä¸ªå¯„å­˜å™¨ */

		buf[0] = (0 << 3) | (1 << 2) | (0 << 1);//æ­¤å¤„(0 << 1)è¡¨ç¤ºå…³é—­BUFFER,æ”¹ä¸º(1 << 1)è¡¨ç¤ºæ‰“å¼€BUFFER

		buf[1] = 0x08;	/* é«˜å››ä½0è¡¨ç¤ºAINPæ¥ AIN0,  ä½å››ä½8è¡¨ç¤º AINN å›ºå®šæ¥ AINCOM */

		buf[2] = (0 << 5) | (0 << 3) | (_gain << 0);

		buf[3] = s_tabDataRate[_drate];	// DRATE_10SPS;	/* é€‰æ‹©æ•°æ®è¾“å‡ºé€Ÿç‡ */
		
		ADS_CS_LOW();	/* SPIç‰‡é€‰ = 0 */
		ADS1256_Send8Bit(CMD_WREG | 0);	/* å†™å¯„å­˜å™¨çš„å‘½ä»¤, å¹¶å‘é€å¯„å­˜å™¨åœ°å€ */
		ADS1256_Send8Bit(0x03);					/* å¯„å­˜å™¨ä¸ªæ•° - 1, æ­¤å¤„3è¡¨ç¤ºå†™4ä¸ªå¯„å­˜å™¨ */
		ADS1256_Send8Bit(buf[0]);				/* è®¾ç½®çŠ¶æ€å¯„å­˜å™¨ */
		ADS1256_Send8Bit(buf[1]);				/* è®¾ç½®è¾“å…¥é€šé“å‚æ•° */
		ADS1256_Send8Bit(buf[2]);				/* è®¾ç½®ADCONæ§åˆ¶å¯„å­˜å™¨ï¼Œå¢ç›Š */
		ADS1256_Send8Bit(buf[3]);				/* è®¾ç½®è¾“å‡ºæ•°æ®é€Ÿç‡ */
		ADS_CS_HIGH();	/* SPIç‰‡é€‰ = 1 */
	}

	bsp_DelayUS(50);
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_DelayDATA
*	åŠŸèƒ½è¯´æ˜: è¯»å–DOUTä¹‹å‰çš„å»¶è¿Ÿ
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
 void ADS1256_DelayDATA(void)
{
	/*
		Delay from last SCLK edge for DIN to first SCLK rising edge for DOUT: RDATA, RDATAC,RREG Commands
		æœ€å° 50 ä¸ªtCLK = 50 * 0.13uS = 6.5uS
	*/
	bsp_DelayUS(10);	/* æœ€å°å»¶è¿Ÿ 6.5uS, æ­¤å¤„å–10us */
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_ResetHard
*	åŠŸèƒ½è¯´æ˜: ç¡¬ä»¶å¤ä½ ADS1256èŠ¯ç‰‡.ä½ç”µå¹³å¤ä½ã€‚æœ€å¿«4ä¸ªæ—¶é’Ÿï¼Œä¹Ÿå°±æ˜¯ 4x0.13uS = 0.52uS
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
static void ADS1256_ResetHard(void)
{
	/* ADS1256æ•°æ®æ‰‹å†Œç¬¬7é¡µ */
	//RESET_0();			/* å¤ä½ */
	//bsp_DelayUS(5);
	//RESET_1();

	bsp_DelayUS(5);
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_Send8Bit
*	åŠŸèƒ½è¯´æ˜: å‘SPIæ€»çº¿å‘é€8ä¸ªbitæ•°æ®ã€‚ ä¸å¸¦CSæ§åˆ¶ã€‚
*	å½¢    å‚: _data : æ•°æ®
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
static void ADS1256_Send8Bit(uint8_t _data)
{
	HAL_SPI_Transmit(&hspi3,&_data,1, 1000);
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_Recive8Bit
*	åŠŸèƒ½è¯´æ˜: ä»SPIæ€»çº¿æ¥æ”¶8ä¸ªbitæ•°æ®ã€‚ ä¸å¸¦CSæ§åˆ¶ã€‚
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
static uint8_t ADS1256_Recive8Bit(void)
{
	uint8_t Rxdata;
	HAL_SPI_Receive(&hspi3,&Rxdata,1, 1000);
	return Rxdata;
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_WriteReg
*	åŠŸèƒ½è¯´æ˜: å†™æŒ‡å®šçš„å¯„å­˜å™¨
*	å½¢    å‚:  _RegID : å¯„å­˜å™¨ID
*			  _RegValue : å¯„å­˜å™¨å€¼
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
static void ADS1256_WriteReg(uint8_t _RegID, uint8_t _RegValue)
{
	ADS_CS_LOW();
	ADS1256_Send8Bit(CMD_WREG | _RegID);
	ADS1256_Send8Bit(0x00);

	ADS1256_Send8Bit(_RegValue);
	ADS_CS_HIGH();
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_ReadReg
*	åŠŸèƒ½è¯´æ˜: å†™æŒ‡å®šçš„å¯„å­˜å™¨
*	å½¢    å‚:  _RegID : å¯„å­˜å™¨ID
*			  _RegValue : å¯„å­˜å™¨å€¼ã€‚
*	è¿” å› å€¼: è¯»åˆ°çš„å¯„å­˜å™¨å€¼ã€‚
*********************************************************************************************************
*/
static uint8_t ADS1256_ReadReg(uint8_t _RegID)
{
	uint8_t read;

	ADS_CS_LOW();
	ADS1256_Send8Bit(CMD_RREG | _RegID);	
	ADS1256_Send8Bit(0x00);	

	ADS1256_DelayDATA();

	read = ADS1256_Recive8Bit();
	ADS_CS_HIGH();

	return read;
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_WriteCmd
*	åŠŸèƒ½è¯´æ˜: å‘é€å•å­—èŠ‚å‘½ä»¤
*	å½¢    å‚:  _cmd : å‘½ä»¤
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
void ADS1256_WriteCmd(uint8_t _cmd)
{
	ADS_CS_LOW();	/* SPIç‰‡é€‰ = 0 */
	ADS1256_Send8Bit(_cmd);
	ADS_CS_HIGH();	/* SPIç‰‡é€‰ = 1 */
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_ReadChipID
*	åŠŸèƒ½è¯´æ˜: è¯»èŠ¯ç‰‡ID, è¯»çŠ¶æ€å¯„å­˜å™¨ä¸­çš„é«˜4bit
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: 8bitçŠ¶æ€å¯„å­˜å™¨å€¼çš„é«˜4ä½
*********************************************************************************************************
*/
uint8_t ADS1256_ReadChipID(void)
{
	uint8_t id;

	ADS1256_WaitDRDY();
	id = ADS1256_ReadReg(REG_STATUS);
	return (id >> 4);
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_SetChannal
*	åŠŸèƒ½è¯´æ˜: é…ç½®é€šé“å·ã€‚å¤šè·¯å¤ç”¨ã€‚AIN- å›ºå®šæ¥åœ°ï¼ˆACOM).
*	å½¢    å‚: _ch : é€šé“å·ï¼Œ 0-7
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
static void ADS1256_SetChannal(uint8_t _ch)
{
	if (_ch > 7)
	{
		return;
	}
	ADS1256_WriteReg(REG_MUX, (_ch << 4) | (1 << 3));	/* Bit3 = 1, AINN å›ºå®šæ¥ AINCOM */
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_SetDiffChannal
*	åŠŸèƒ½è¯´æ˜: é…ç½®å·®åˆ†é€šé“å·ã€‚å¤šè·¯å¤ç”¨ã€‚
*	å½¢    å‚: _ch : é€šé“å·,0-3ï¼›å…±4å¯¹
*	è¿” å› å€¼: 8bitçŠ¶æ€å¯„å­˜å™¨å€¼çš„é«˜4ä½
*********************************************************************************************************
*/
//static void ADS1256_SetDiffChannal(uint8_t _ch)
//{
//	if (_ch == 0)
//	{
//		ADS1256_WriteReg(REG_MUX, (0 << 4) | 1);	/* å·®åˆ†è¾“å…¥ AIN0ï¼Œ AIN1 */
//	}
//	else if (_ch == 1)
//	{
//		ADS1256_WriteReg(REG_MUX, (2 << 4) | 3);	/* å·®åˆ†è¾“å…¥ AIN2ï¼Œ AIN3 */
//	}
//	else if (_ch == 2)
//	{
//		ADS1256_WriteReg(REG_MUX, (4 << 4) | 5);	/* å·®åˆ†è¾“å…¥ AIN4ï¼Œ AIN5 */
//	}
//	else if (_ch == 3)
//	{
//		ADS1256_WriteReg(REG_MUX, (6 << 4) | 7);	/* å·®åˆ†è¾“å…¥ AIN6ï¼Œ AIN7 */
//	}
//}

void ADS1256_SetDiffChannal(uint8_t _ch) //µ÷»»ºóµÄAIN0(N)-AIN1(P)
{
	if (_ch == 0)
	{
		// ????:AIN1(P?)?AIN0(N?)
		ADS1256_WriteReg(REG_MUX, (1 << 4) | 0);	
	}
	else if (_ch == 1)
	{
		// ?AIN2(P)/AIN3(N),????(????????)
		ADS1256_WriteReg(REG_MUX, (3 << 4) | 2);	
	}
	else if (_ch == 2)
	{
		// ?AIN4(P)/AIN5(N),????
		ADS1256_WriteReg(REG_MUX, (5 << 4) | 4);	
	}
	else if (_ch == 3)
	{
		// ?AIN6(P)/AIN7(N),????
		ADS1256_WriteReg(REG_MUX, (7 << 4) | 6);	
	}
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_WaitDRDY
*	åŠŸèƒ½è¯´æ˜: ç­‰å¾…å†…éƒ¨æ“ä½œå®Œæˆã€‚ è‡ªæ ¡å‡†æ—¶é—´è¾ƒé•¿ï¼Œéœ€è¦ç­‰å¾…ã€‚
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
static void ADS1256_WaitDRDY(void)
{
	uint32_t i;

	for (i = 0; i < 40000000; i++)
	{
		if (DRDY_IS_LOW())
		{
			break;
		}
	}
	if (i >= 40000000)
	{
		printf("ADS1256_WaitDRDY() Time Out ...\r\n");		/* è°ƒè¯•è¯­å¥. ç”¨è¯­æ’é”™ */
//		USB_SendStr("ADS1256_WaitDRDY() Time Out ...\r\n");		/* è°ƒè¯•è¯­å¥. ç”¨è¯­æ’é”™ */
	}
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_ReadData
*	åŠŸèƒ½è¯´æ˜: è¯»ADCæ•°æ®
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
static int32_t ADS1256_ReadData(void)
{
	uint32_t read = 0;

	ADS_CS_LOW();	/* SPIç‰‡é€‰ = 0 */

	ADS1256_Send8Bit(CMD_RDATA);	/* è¯»æ•°æ®çš„å‘½ä»¤ */

	ADS1256_DelayDATA();	/* å¿…é¡»å»¶è¿Ÿæ‰èƒ½è¯»å–èŠ¯ç‰‡è¿”å›æ•°æ® */

	/* è¯»é‡‡æ ·ç»“æœï¼Œ3ä¸ªå­—èŠ‚ï¼Œé«˜å­—èŠ‚åœ¨å‰ */
	read = ADS1256_Recive8Bit() << 16;
	read += (ADS1256_Recive8Bit() << 8);
	read += ADS1256_Recive8Bit();

	ADS_CS_HIGH();	/* SPIç‰‡é€‰ = 1 */

	/* è´Ÿæ•°è¿›è¡Œæ‰©å±•ã€‚24ä½æœ‰ç¬¦å·æ•°æ‰©å±•ä¸º32ä½æœ‰ç¬¦å·æ•° */
	if (read & 0x800000)
	{
		read += 0xFF000000;
	}

	return (int32_t)read;
}

#if 0
/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_ReadAdc
*	åŠŸèƒ½è¯´æ˜: è¯»æŒ‡å®šé€šé“çš„ADCæ•°æ®
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
int32_t ADS1256_ReadAdc(uint8_t _ch)
{
	/* ADS1256 æ•°æ®æ‰‹å†Œç¬¬21é¡µ */

#if 0	/* å¯¹äº30Ksps é‡‡æ ·é€Ÿç‡ */
	int32_t read;

	while (DRDY_IS_LOW());	/* ç­‰å¾… DRDY é«˜ */
	while (!DRDY_IS_LOW());	/* ç­‰å¾… DRDY ä½ */

	ADS1256_SetChannal(_ch);	/* åˆ‡æ¢æ¨¡æ‹Ÿé€šé“ */
	bsp_DelayUS(5);

	ADS1256_WriteCmd(CMD_SYNC);
	bsp_DelayUS(5);

	ADS1256_WriteCmd(CMD_WAKEUP);  /* æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ—¶å€™ DRDY å·²ç»ä¸ºé«˜ */
	bsp_DelayUS(25);

	read =  (int32_t)ADS1256_ReadData();

	while (DRDY_IS_LOW());	/* ç­‰å¾… DRDY é«˜ */
	while (!DRDY_IS_LOW());	/* ç­‰å¾… DRDY ä½ */

	read =  (int32_t)ADS1256_ReadData();

	return read;
#else
	//while (DRDY_IS_LOW());

	/* ADS1256 æ•°æ®æ‰‹å†Œç¬¬21é¡µ */
	ADS1256_WaitDRDY();		/* ç­‰å¾… DRDY = 0 */

	ADS1256_SetChannal(_ch);	/* åˆ‡æ¢æ¨¡æ‹Ÿé€šé“ */
	bsp_DelayUS(5);

	ADS1256_WriteCmd(CMD_SYNC);
	bsp_DelayUS(5);

	ADS1256_WriteCmd(CMD_WAKEUP);
	bsp_DelayUS(25);

	//ADS1256_WaitDRDY();		/* ç­‰å¾… DRDY = 0 */

	return (int32_t)ADS1256_ReadData();
#endif
}
#endif

/*
*********************************************************************************************************
*	ä¸‹é¢çš„å‡½æ•°ç”¨äºDRDYä¸­æ–­å·¥ä½œæ¨¡å¼
*********************************************************************************************************
*/

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_StartScan
*	åŠŸèƒ½è¯´æ˜: å°† DRDYå¼•è„š ï¼ˆPC3 ï¼‰é…ç½®æˆå¤–éƒ¨ä¸­æ–­è§¦å‘æ–¹å¼ï¼Œ ä¸­æ–­æœåŠ¡ç¨‹åºä¸­æ‰«æ8ä¸ªé€šé“çš„æ•°æ®ã€‚
*	å½¢    å‚: _ucDiffMode : 0 è¡¨ç¤ºå•ç«¯æ¨¡å¼ï¼ˆæ‰«æ8è·¯ï¼‰ï¼› 1è¡¨ç¤ºå·®åˆ†æ¨¡å¼ï¼Œæ‰«æ4è·¯
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
void ADS1256_StartScan(uint8_t _ucScanMode)
{
	

	g_tADS1256.ScanMode = _ucScanMode;
	/* å¼€å§‹æ‰«æå‰, æ¸…é›¶ç»“æœç¼“å†²åŒº */
	{
		uint8_t i;

		g_tADS1256.Channel = 0;

		for (i = 0; i < 8; i++)
		{
			g_tADS1256.AdcNow[i] = 0;
		}
	}
	
	HAL_NVIC_EnableIRQ(EXTI2_IRQn);//ä½¿èƒ½å¤–éƒ¨ä¸­æ–­
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_StopScan
*	åŠŸèƒ½è¯´æ˜: åœæ­¢ DRDY ä¸­æ–­
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
void ADS1256_StopScan(void)
{
	HAL_NVIC_DisableIRQ(EXTI2_IRQn);//å¤±èƒ½å¤–éƒ¨ä¸­æ–­
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_GetAdc
*	åŠŸèƒ½è¯´æ˜: ä»ç¼“å†²åŒºè¯»å–ADCé‡‡æ ·ç»“æœã€‚é‡‡æ ·ç»“æ„æ˜¯ç”±ä¸­æ–­æœåŠ¡ç¨‹åºå¡«å……çš„ã€‚
*	å½¢    å‚: _ch é€šé“å· (0 - 7)
*	è¿” å› å€¼: ADCé‡‡é›†ç»“æœï¼ˆæœ‰ç¬¦å·æ•°ï¼‰
*********************************************************************************************************
*/
int32_t ADS1256_GetAdc(uint8_t _ch)
{
	int32_t iTemp;

	if (_ch > 7)
	{
		return 0;
	}

	__set_PRIMASK(1);	/* ç¦æ­¢ä¸­æ–­ */

	iTemp = g_tADS1256.AdcNow[_ch];

	__set_PRIMASK(0);	/* ä½¿èƒ½ä¸­æ–­ */

	return iTemp;
}

/*
*********************************************************************************************************
*	å‡½ æ•° å: ADS1256_ISR
*	åŠŸèƒ½è¯´æ˜: å®šæ—¶é‡‡é›†ä¸­æ–­æœåŠ¡ç¨‹åº
*	å½¢    å‚: æ— 
*	è¿” å› å€¼: æ— 
*********************************************************************************************************
*/
void ADS1256_ISR(void)
{
	if (g_tADS1256.ScanMode == 0)	/* 0 è¡¨ç¤ºå•ç«¯8è·¯æ‰«æï¼Œ1è¡¨ç¤ºå·®åˆ†4è·¯æ‰«æ */
	{
		/* è¯»å–é‡‡é›†ç»“æ„ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡ */
		ADS1256_SetChannal(g_tADS1256.Channel);	/* åˆ‡æ¢æ¨¡æ‹Ÿé€šé“ */
		bsp_DelayUS(5);

		ADS1256_WriteCmd(CMD_SYNC);
		bsp_DelayUS(5);

		ADS1256_WriteCmd(CMD_WAKEUP);
		bsp_DelayUS(25);

		if (g_tADS1256.Channel == 0)
		{
			g_tADS1256.AdcNow[7] = ADS1256_ReadData();	/* æ³¨æ„ä¿å­˜çš„æ˜¯ä¸Šä¸€ä¸ªé€šé“çš„æ•°æ® */
		}
		else
		{
			g_tADS1256.AdcNow[g_tADS1256.Channel-1] = ADS1256_ReadData();	/* æ³¨æ„ä¿å­˜çš„æ˜¯ä¸Šä¸€ä¸ªé€šé“çš„æ•°æ® */
		}

		if (++g_tADS1256.Channel >= 8)
		{
			g_tADS1256.Channel = 0;
		}
	}
	else	/* å·®åˆ†4è·¯æ‰«æ */
	{
		/* è¯»å–é‡‡é›†ç»“æ„ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡ */
		ADS1256_SetDiffChannal(g_tADS1256.Channel);	/* åˆ‡æ¢æ¨¡æ‹Ÿé€šé“ */
		bsp_DelayUS(5);

		ADS1256_WriteCmd(CMD_SYNC);
		bsp_DelayUS(5);

		ADS1256_WriteCmd(CMD_WAKEUP);
		bsp_DelayUS(25);

		if (g_tADS1256.Channel == 0)
		{
			g_tADS1256.AdcNow[3] = ADS1256_ReadData();	/* æ³¨æ„ä¿å­˜çš„æ˜¯ä¸Šä¸€ä¸ªé€šé“çš„æ•°æ® */
		}
		else
		{
			g_tADS1256.AdcNow[g_tADS1256.Channel-1] = ADS1256_ReadData();	/* æ³¨æ„ä¿å­˜çš„æ˜¯ä¸Šä¸€ä¸ªé€šé“çš„æ•°æ® */
		}

		if (++g_tADS1256.Channel >= 4)
		{
			g_tADS1256.Channel = 0;
		}
	}
}
/*
*********************************************************************************************************
*                                             
*	æ¨¡å—åç§° : ADS1256 é©±åŠ¨æ¨¡å—(8é€šé“å¸¦PGAçš„24ä½ADC)
*	æ–‡ä»¶åç§° : bsp_ads1256.c
*	ç‰ˆ    æœ¬ : V1.1
* ä½œ    è€… : å¼ è±ªæ´‹
*	è¯´    æ˜ : ADS1256æ¨¡å—å’ŒCPUä¹‹é—´é‡‡ç”¨SPIæ¥å£ã€‚
*********************************************************************************************************
*/
